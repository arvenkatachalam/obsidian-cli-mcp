/**
 * Penetration test suite for obsidian-cli-mcp
 *
 * All findings P1-P8 have been fixed. These tests confirm that dangerous
 * inputs are now correctly REJECTED by validation schemas.
 */

import { describe, it, expect } from "vitest";
import {
  safeFileSchema,
  safePathSchema,
  vaultNameSchema,
  safePropertyNameSchema,
  safeExtSchema,
  buildObsidianArgs,
} from "../src/cli.js";
import { z } from "zod";

// ─────────────────────────────────────────────────────────────
// P1 — PATH_UNSAFE regex now catches trailing ".." (no separator)
// ─────────────────────────────────────────────────────────────

describe("P1 [FIXED] — trailing '..' path traversal is rejected", () => {
  const bypasses = [
    "notes/..",
    "folder/subfolder/..",
    "..",
    "deep/nest/dir/..",
  ];

  for (const payload of bypasses) {
    it(`safeFileSchema rejects "${payload}"`, () => {
      expect(safeFileSchema.safeParse(payload).success).toBe(false);
    });

    it(`safePathSchema rejects "${payload}"`, () => {
      expect(safePathSchema.safeParse(payload).success).toBe(false);
    });
  }
});

// ─────────────────────────────────────────────────────────────
// P2 — vault parameter now uses vaultNameSchema on all tools
// ─────────────────────────────────────────────────────────────

describe("P2 [FIXED] — vault param uses vaultNameSchema", () => {
  const maliciousVaults = [
    "vault; rm -rf /",
    "vault`whoami`",
    "vault$(id)",
    "--malicious-flag=value!",
    "../../etc",
    "/absolute/path",
    "vault\x00injected",
  ];

  for (const vault of maliciousVaults) {
    it(`vaultNameSchema rejects "${vault.replace(/\x00/g, "\\0")}"`, () => {
      expect(vaultNameSchema.safeParse(vault).success).toBe(false);
    });
  }
});

// ─────────────────────────────────────────────────────────────
// P3 — obsidian_create `name` now uses safeFileSchema
// ─────────────────────────────────────────────────────────────

describe("P3 [FIXED] — obsidian_create name rejects path traversal", () => {
  const traversals = [
    "../../../etc/cron.d/evil",
    "/etc/passwd",
    "../../.ssh/authorized_keys",
    "..\\..\\windows\\system32\\evil.md",
    "legitimate\x00.md",
  ];

  for (const payload of traversals) {
    it(`safeFileSchema rejects "${payload.replace(/\x00/g, "\\0")}"`, () => {
      expect(safeFileSchema.safeParse(payload).success).toBe(false);
    });
  }
});

// ─────────────────────────────────────────────────────────────
// P4 — obsidian_create `template` now uses safeFileSchema
// ─────────────────────────────────────────────────────────────

describe("P4 [FIXED] — obsidian_create template rejects path traversal", () => {
  const payloads = [
    "../../../etc/passwd",
    "/etc/shadow",
    "../../.env",
    "..\\..\\secrets.md",
  ];

  for (const payload of payloads) {
    it(`safeFileSchema rejects "${payload}"`, () => {
      expect(safeFileSchema.safeParse(payload).success).toBe(false);
    });
  }
});

// ─────────────────────────────────────────────────────────────
// P5 — obsidian_property_set `name` now uses safePropertyNameSchema
// ─────────────────────────────────────────────────────────────

describe("P5 [FIXED] — property_set name is validated", () => {
  const rejected = [
    "key: value\nnewkey: injected",  // newline = YAML injection
    "a".repeat(201),                  // over 200 char limit
    "key=value",                      // equals not allowed
    "key\ttab",                       // tab not allowed
    "name;drop",                      // semicolon not allowed
  ];

  for (const payload of rejected) {
    it(`safePropertyNameSchema rejects "${payload.slice(0, 40)}..."`, () => {
      expect(safePropertyNameSchema.safeParse(payload).success).toBe(false);
    });
  }

  // These are valid property names — the schema allows word chars, hyphens, dots, spaces
  const accepted = [
    "title",
    "my-property",
    "my_property",
    "My Property",
    "---",           // just dashes, valid
    "__proto__",     // just word chars, valid (Obsidian handles safely)
    "constructor",   // just word chars, valid
  ];

  for (const name of accepted) {
    it(`safePropertyNameSchema accepts "${name}"`, () => {
      expect(safePropertyNameSchema.safeParse(name).success).toBe(true);
    });
  }
});

// ─────────────────────────────────────────────────────────────
// P6 — obsidian_files `ext` now uses safeExtSchema
// ─────────────────────────────────────────────────────────────

describe("P6 [FIXED] — obsidian_files ext is validated", () => {
  const payloads = [
    "../../../etc/passwd",
    "; rm -rf /",
    "md\x00exe",
    "a".repeat(21),
  ];

  for (const payload of payloads) {
    it(`safeExtSchema rejects "${payload.slice(0, 40).replace(/\x00/g, "\\0")}"`, () => {
      expect(safeExtSchema.safeParse(payload).success).toBe(false);
    });
  }

  it("accepts valid extensions", () => {
    expect(safeExtSchema.safeParse("md").success).toBe(true);
    expect(safeExtSchema.safeParse("txt").success).toBe(true);
    expect(safeExtSchema.safeParse("canvas").success).toBe(true);
  });
});

// ─────────────────────────────────────────────────────────────
// P7 — Length limits now enforced on schemas
// ─────────────────────────────────────────────────────────────

describe("P7 [FIXED] — input length limits enforced", () => {
  it("safeFileSchema rejects strings over 10000 chars", () => {
    const long = "x".repeat(10001);
    expect(safeFileSchema.safeParse(long).success).toBe(false);
  });

  it("safePathSchema rejects strings over 10000 chars", () => {
    const long = "x".repeat(10001);
    expect(safePathSchema.safeParse(long).success).toBe(false);
  });

  it("safePropertyNameSchema rejects strings over 200 chars", () => {
    const long = "x".repeat(201);
    expect(safePropertyNameSchema.safeParse(long).success).toBe(false);
  });

  it("safeExtSchema rejects strings over 20 chars", () => {
    const long = "x".repeat(21);
    expect(safeExtSchema.safeParse(long).success).toBe(false);
  });
});

// ─────────────────────────────────────────────────────────────
// P8 — vaultNameSchema now rejects leading dashes
// ─────────────────────────────────────────────────────────────

describe("P8 [FIXED] — vault name rejects leading dashes", () => {
  it("rejects '--help'", () => {
    expect(vaultNameSchema.safeParse("--help").success).toBe(false);
  });

  it("rejects '--version'", () => {
    expect(vaultNameSchema.safeParse("--version").success).toBe(false);
  });

  it("rejects '-v'", () => {
    expect(vaultNameSchema.safeParse("-v").success).toBe(false);
  });

  it("allows vault names with hyphens in the middle", () => {
    expect(vaultNameSchema.safeParse("my-vault").success).toBe(true);
    expect(vaultNameSchema.safeParse("My Vault (2024)").success).toBe(true);
  });
});
